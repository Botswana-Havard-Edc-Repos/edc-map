<html>
  <head>
  	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta http-equiv="content" content="text/html; charset=UTF-8" />
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyDtDT8oMKum1AObKpgTTWox4wSgc4O_QU8&libraries=geometry,drawing"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style type="text/css">
      html, body, #map { height: 600px; width: 800px; margin: 50px; padding: 0px}
    </style>
    <script type="text/javascript">
    var map;
    var geocoder; 
    var polygonArray = [];
    var itemsInPolygon = []
    var point = new google.maps.LatLng(-24.655299, 25.925627);

    //function called Initialize the map when loading the browser
    function initialize() {
        //create map object
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 14,
            center: new google.maps.LatLng(-24.655299, 25.925627),
            mapTypeId: google.maps.MapTypeId.SATELLITE
        });
        var drawingManager = new google.maps.drawing.DrawingManager({
            drawingMode: google.maps.drawing.OverlayType.POLYGON,
            drawingControl: true,
            drawingControlOptions: {
              position: google.maps.ControlPosition.TOP_CENTER,
              drawingModes: [
                google.maps.drawing.OverlayType.MARKER,
                google.maps.drawing.OverlayType.CIRCLE,
                google.maps.drawing.OverlayType.POLYGON,
                google.maps.drawing.OverlayType.POLYLINE,
                google.maps.drawing.OverlayType.RECTANGLE
              ]
            },
            markerOptions: {
              icon: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png'
            },
            circleOptions: {
              fillColor: '#ffff00',
              fillOpacity: 1,
              strokeWeight: 5,
              clickable: false,
              editable: true,
              zIndex: 1
            },
            polygonOptions: {
              fillColor: '#BCDCF9',
              fillOpacity: 0.5,
              strokeWeight: 2,
              strokeColor: '#57ACF9',
              clickable: false,
              editable: false,
              zIndex: 1
            }
          });
          console.log(drawingManager)
          drawingManager.setMap(map)
          google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon) {
        	    $('#save_map_selection').removeAttr('disabled');
        	    polygon.getPath().forEach(function(latLng){polygonArray.push(latLng.toString());})
        	    /*
                 * Save polygon, call the 'polygon.containsLatLon' function then send identifiers within the polygon
                 *  to a 'save_map_selection' view in views.py
                 */
                $('#save_map_selection').click(function() {
                    {% if items %}
            	        //check in the payload to see which points are withing a polygon then push their identifiers into an array
            	        {% for lat, lon, label in items %}
            	            var point = new google.maps.LatLng({{ lat }}, {{ lon }});
            	          	if (google.maps.geometry.poly.containsLocation(point, polygon)){
                	    		itemsInPolygon.push({{ label }});
                  	     	}
            	          	window.alert(itemsInPolygon);
            	          	window.alert(polygonArray);
            	        {% endfor %}
            	    	//TODO save points in a polygon to a section
            			{% endif %} 
                });
        	  });
          
    } //initialze
    google.maps.event.addDomListener(window, "load", initialize);
    </script>
  </head>
  <body onload="initialize()">
	<div id="map"></div>
	<table align="center">
	   	<tr valign="middle">
	   		<td>
		    	<button id="save_map_selection" disabled="disabled">Save cluster</button> 
			</td>
		</tr>
     </table>
  </body>
</html>